<h1 align="center">
Vision Transformer Based Video Hashing Retrieval for Tracing the Source of Fake VideosüéâÔ∏è
</h1>

## üìú Directory

- [Introduction](#-introduction)
  - [VTL](#vtl)
  - [Trace Samples and Acc of HashBits](#trace-samples-and-acc-of-hashbits)
  - [DFTL Dataset Samples](#dftl-dataset-samples)
  - [DAVIS2016-TL Dataset Samples](#davis2016-tl-dataset-samples)
- [Train or Test](#-train-or-test)
  - [Datasets](#datasets)
  - [Train ViTHash](#train-vithash)
  - [Train Generator](#train-generator)
  - [Test IOU](#test-iou)
  - [Test ViTHash](#test-vithash)
  - [Test CSQ](#test-csq)
- [Tracing](#%EF%B8%8F-tracing)
  - [Trace Samples](#trace-samples)
- [Localization](#%EF%B8%8F-localization)
  - [Localization Samples](#localization-samples)

## ‚ú® Introduction

### VTL

> Video Tracing and Tampering Localization (VTL). A novel framework to detect fake video **(clipping, cropping, blur, etc.)** by tracing the source video of fake video. 1) Training hash centers as HCs. 2) Finding index of source video from HCs. 3) Masking the different between fake video and source video as a result of comparison **(auxiliary information)**.

<div align="center">
    <img src="./assets/flow-chart.png" width="720px" >
</div>

### Trace Samples and Acc of HashBits

<div align="center">
    <img src="./images/trace_dftl.png" height="230px" >
    <img src="./images/acc.png" height="230px" >
</div>

### DFTL Dataset Samples

> Same person with different scenes. You can download full 16 minutes videos of source video and fake video by follows link.

<div style="align-items: center;text-align: center; display: inline-block" >
    <div>
        <h3 align="center"><a href="assets/source.mp4">Source Videos</a></h3>
        <div  align="center">
            <img src="./assets/girl_r0.gif" width="240px" >
            <img src="./assets/girl_r1.gif" width="240px" >
            <img src="./assets/girl_r2.gif" width="240px" >
        </div>
    </div>
    <div>
        <h3 align="center"><a href="assets/girl.mp4">Fake Videos</a></h3>
        <div  align="center">
            <img src="./assets/girl_f0.gif" width="240px" >
            <img src="./assets/girl_f1.gif" width="240px" >
            <img src="./assets/girl_f2.gif" width="240px" >
        </div>
    </div>  
</div>

> Different fake videos from same source.

<div style="align-items: center;text-align: center; display: inline-block" >
    <div>
        <h3 align="center">Source Video</h3>
        <div  align="center">
            <img src="./assets/40.gif" width="240px" >
        </div>
    </div>
    <div>
        <h3 align="center">Fake Videos of Different Face Swap Methods</h3>
        <div  align="center">
            <img src="./assets/male-f1.gif" width="240px" >
            <img src="./assets/male-f2.gif" width="240px" >
            <img src="./assets/male-f3.gif" width="240px" >
        </div>
    </div>  
</div>

### DAVIS2016-TL Dataset Samples

> The first gif of boat is source video, and remaining five videos generated by different inpainting methods.

<div align="center" >
    <div>
        <div  align="center">
            <img src="./assets/boat.gif" width="260px" height="150px" >
            <img src="./assets/boat_f0.gif" width="260px" height="150px" >
            <img src="./assets/boat_f2.gif" width="260px" height="150px" >
        </div>
    </div>
    <div>
        <div  align="center">
            <img src="./assets/boat_f3.gif" width="260px" height="150px" >
            <img src="./assets/boat_f4.gif" width="260px" height="150px" >
            <img src="./assets/boat_f5.gif" width="260px" height="150px" >
        </div>
    </div>  
</div>

## üî¨ Train or Test

### Datasets

**Download**  [BaiduNetdisk](https://pan.baidu.com/s/1PPlDaB4qH2hcU9TQY_KGdA) codeÔºöVTLs

* actors: Source videos and fake videos of 16minutes
* DFTL: Dataset of DFTL
* DAVIS2016-TL: Extension of [DAVIS2016](https://davischallenge.org/)

Extract to the same directory of our code (vtl).

Example:

* vtl: our code
* vrf: dataset of DFTL
* inpainting: dataset of DAVIS2016-TL

### Train

**Pretrained models and hash centers**

> pip install -r requirements.txt


| Model     | DFTL                               | DAVIS2016-TL                         |
| ----------- | ------------------------------------ | -------------------------------------- |
| ViTHash   | [64-1024bits](./model/deepfake)    | [64-1024bits](./model/inpainting)    |
| Generator | [link](./model/deepfake/net_g.pth) | [link](./model/inpainting/net_g.pth) |

**Parameters**

* local_rank: gpu id
* path: dataset path
* type: choice dataloader
  * 0: DFTL dataloader, dir name is **vrf**
  * 1: DAVIS2016-TL dataloader, dir name is **inpainting**

**Train ViTHash**

```apache
python train_h.py --local_rank=0 --path=../vrf --type=0 --bits=128
```

**Train Generator**

```apache
python train_g.py --local_rank=0 --path=../vrf --type=0
```

### Test

**Test IOU**

The test script will test Generator of VTL and DMAC together on DFTL and DAVIS2016-TL.
You can modify it for yourself.

```apache
python test_iou.py
```

**Test ViTHash**

1. type: choice dataloader
   * 0: DFTL dataloader, dir name is **vrf**
   * 1: DAVIS2016-TL dataloader, dir name is **inpainting**
2. path: dataset path
3. hashbits: 128 256 512 or 1024, will load different pre-trained model and hash JSON file.

```apache
python test.py 1 ../inpainting 512
```

**Test CSQ**

1. cd ./CSQ
2. run test script

```apache
python hash_test_vrf.py --dataset=Inpainting --pretrained_3d=./Inpainting_64bits.pth
```

## üöÄÔ∏è Tracing

### Trace Samples

<div align="center">
    <img src="./images/trace-2016-2.jpg" height="200px" >
    <img src="./images/trace_2016-1.jpg" height="200px" >
    <img src="./images/trace_dftl-0.jpg" height="200px" >
</div>

## üëÄÔ∏è Localization

### Localization Samples

<div align="center">
<h3>DAVIS2016-TL</h3>
<div>
    <img src="./images/37_1_mask.jpg" width="250px" >
    <img src="./images/animal.jpg" width="250px" >
</div>
</div>
<div align="center">
<h3>DFTL</h3>
<div  align="center">
    <img src="./assets/l.jpg" width="250px" >
    <img src="./assets/r.jpg" width="250px" >
</div>
</div>
